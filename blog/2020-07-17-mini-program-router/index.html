<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<title data-react-helmet="true">细说微信小程序路由 | TaroX</title><meta data-react-helmet="true" property="og:title" content="细说微信小程序路由 | TaroX"><meta data-react-helmet="true" name="description" content="React"><meta data-react-helmet="true" property="og:description" content="React"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.318da8f0.css">
<link rel="stylesheet" href="/main.2901c7f1.css">
<link rel="stylesheet" href="/1494de57.00e4b234.css">
<link rel="preload" href="/styles.d3ec5c41.js" as="script">
<link rel="preload" href="/runtime~main.667b2516.js" as="script">
<link rel="preload" href="/main.8e74c15f.js" as="script">
<link rel="preload" href="/3.97b79253.js" as="script">
<link rel="preload" href="/4.6e302ae9.js" as="script">
<link rel="preload" href="/5.c384214e.js" as="script">
<link rel="preload" href="/ccc49370.58823dac.js" as="script">
<link rel="preload" href="/162.7313dacb.js" as="script">
<link rel="preload" href="/1494de57.7598e39e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_OaSq"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="TaroX Logo"><strong class="navbar__title">TaroX</strong></a><a class="navbar__item navbar__link" href="/docs/ui/README">UI</a><a class="navbar__item navbar__link" href="/docs/hooks/README">Hooks</a><a class="navbar__item navbar__link" href="/docs/library/README">Library</a><a class="navbar__item navbar__link" href="/docs/polyfill/README">Polyfill</a><a class="navbar__item navbar__link" href="/docs/history/README">History</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tarojsx" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link octicon-mark-github"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="TaroX Logo"><strong class="navbar__title">TaroX</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/ui/README">UI</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/hooks/README">Hooks</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/library/README">Library</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/polyfill/README">Polyfill</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/history/README">History</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">博客</a></li><li class="menu__list-item"><a href="https://github.com/tarojsx" target="_blank" rel="noopener noreferrer" class="menu__link octicon-mark-github"></a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_2RZH">细说微信小程序路由</h1><div class="margin-vert--md"><time datetime="2020-07-17T00:00:00.000Z" class="blogPostDate_3tRe">July 17, 2020  · 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/cncolder" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/127009" alt="Colder"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/cncolder" target="_blank" rel="noreferrer noopener">Colder</a></h4><small class="avatar__subtitle"></small></div></div></header><section class="markdown"><p><img src="/img/undraw_by_the_road.svg" alt="React"></p><p>小程序路由，就是每天使用小程序跳转来跳转去的那部分（不是跳一跳），咋一看和 Web 差不多。</p><p><strong>实际上差很多</strong></p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>本文采用 Taro 和 React 中概念，最终是为了解释微信小程序中的问题。</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="路由的由来"></a>路由的由来<a aria-hidden="true" tabindex="-1" class="hash-link" href="#路由的由来" title="Direct link to heading">#</a></h2><p>Web 开发原本没有路由的概念，用户点击 <code>&lt;a&gt;</code> 标签前往新页面，点击后退按钮返回上一页，国内网站喜欢弹出新页面。</p><p>新生代的浏览器意识到总是弹出新窗口，桌面很快变的杂乱无章，于是发明了 Tab 标签，本质上是一样的。</p><p>直到前端进入单页应用时代（SPA），一整个网站放进一个网页里，跳转页面的概念没有了，取而代之的是单页应用切换呈现的内容，也就是今天要谈到的“路由”。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="react-web-路由"></a>React Web 路由<a aria-hidden="true" tabindex="-1" class="hash-link" href="#react-web-路由" title="Direct link to heading">#</a></h2><p>在 React 领域，<a href="https://github.com/ReactTraining/react-router" target="_blank" rel="noopener noreferrer"><code>react-router</code></a> 已经成为默认的路由系统，它通过匹配 URL，找到对应的组件显示出来，可以更新整个页面，也可以只切换一部分。</p><p>为了性能，路由只显示当前页面，之前和之后的页面在离开后会被卸载（componentWillUnmount）。</p><div class="ui_126w" style="font-size:40px"><div class="content_2Qgg" style="font-size:14px;transform:unset"><div style="perspective:1000px;height:500px"><div style="position:absolute;top:50px;border-radius:5px;width:400px;height:300px;opacity:0.4;background:#ddd;transform:rotateY(40deg);left:0;text-decoration:line-through">首页</div><div style="position:absolute;top:50px;border-radius:5px;width:400px;height:300px;opacity:0.4;background:#ddd;transform:rotateY(40deg);left:100px;text-decoration:line-through">博客</div><div style="position:absolute;top:100px;border-radius:5px;width:400px;height:300px;opacity:0.4;background:#ddd;transform:rotateY(40deg);left:110px;text-decoration:line-through">文档</div><div style="position:absolute;top:150px;border-radius:5px;width:400px;height:300px;opacity:0.4;background:#ddd;transform:rotateY(40deg);left:120px;text-decoration:line-through">关于</div><div style="position:absolute;top:50px;border-radius:5px;width:400px;height:300px;opacity:0.9;background:var(--ifm-link-color);transform:rotateY(40deg);left:250px">细说微信小程序路由</div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="小程序路由"></a>小程序路由<a aria-hidden="true" tabindex="-1" class="hash-link" href="#小程序路由" title="Direct link to heading">#</a></h2><p>小程序与 Web 最大的区别是独立的渲染层，这使得小程序有能力维护真实的页面栈（最多 10 个），而不仅仅是逻辑上的路由历史。</p><p><img src="https://res.wx.qq.com/wxdoc/dist/assets/img/4-1.ad156d1c.png" alt="Mini Program Webview and JsCore"></p><p>如果上图中的 3 个 Webview 就是本站的 3 个页面的话，他们之间的关系是这样的：</p><ul><li>打开程序时，“首页”显示。</li><li>打开“博客”，“首页”隐藏，“博客”显示。</li><li>打开“文章”，“博客”隐藏，“文章”显示。</li></ul><div class="ui_126w" style="font-size:40px"><div class="content_2Qgg" style="font-size:14px;transform:unset"><div style="perspective:1000px;height:420px"><div style="position:absolute;top:50px;border-radius:5px;width:400px;height:300px;opacity:0.4;background:var(--ifm-link-color);transform:rotateY(40deg);left:0">首页（隐藏）</div><div style="position:absolute;top:50px;border-radius:5px;width:400px;height:300px;opacity:0.4;background:var(--ifm-link-color);transform:rotateY(40deg);left:100px">博客（隐藏）</div><div style="position:absolute;top:50px;border-radius:5px;width:400px;height:300px;opacity:0.9;background:var(--ifm-link-color);transform:rotateY(40deg);left:250px">细说微信小程序路由（当前）</div></div></div></div><p>这有什么区别呢？想象一下现在你后退到“博客”页面，“博客”只是由隐藏变成显示，不会触发 componentDidMount，本来在这个生命周期里读取文章列表就能更新阅读数，现在没法更新了。</p><p>如果要实现“路过”页面时更新数据，onDidShow 会更加合适。</p><p>这一点反映出小程序中的路由与 Web app 中的路由之间的区别。Web app 只在乎历史记录，而小程序中保留了真实的页面，称为“页面栈”，也就是当前打开的一摞页面。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="小程序页面栈"></a>小程序页面栈<a aria-hidden="true" tabindex="-1" class="hash-link" href="#小程序页面栈" title="Direct link to heading">#</a></h2><p>让我们用一个可操作的例子来演示一下小程序在路由跳转后究竟发生了什么。</p><p>请想象左边是一个带 TabBar 的小程序，右边显示页面栈信息。</p><div class="ui_126w" style="font-size:40px"><div class="content_2Qgg" style="font-size:14px;transform:unset"><div style="display:flex;justify-content:space-around;margin:30px;color:#fff;text-align:center;font-size:28px;font-weight:bolder;cursor:pointer"><div style="border-radius:10px;width:375px;height:550px;background:var(--ifm-link-color)"><div style="height:500px"><div style="visibility:hidden;padding:10px;text-align:left;font-weight:900">&lt; 后退</div><div style="padding-top:20px">UI</div></div><div style="visibility:visible;display:flex;align-items:center;border-radius:0 0 10px 10px;height:50px;background:rgba(60,60,60,.3)"><div class="text--warning" style="flex:1">首页</div><div style="flex:1">我的</div></div></div><div style="display:flex;flex-flow:column;justify-content:flex-end"><div class="text--warning" style="margin:5px;line-height:1.5;border-radius:10px;width:200px;background:var(--ifm-link-color);opacity:1">首页</div></div></div></div></div><p>首先，在小程序刚刚启动时，页面栈是空的。初始化以后，第一个打开的是“首页”，当前页面栈中只有一个页面。</p><ol><li>尝试点击 “UI” - “Button”，页面栈会依次增长，上一个页面依次隐藏（onDidHide）。</li><li>点击“后退”按钮，页面依次卸载（componentWillUnmount），上一页依次显示（onDidShow）。</li><li>直到返回到“首页”，因为是 TabBar 中的页面，一旦打开无法轻易卸载，即使是切换到其他 Tab。</li></ol><p>现在让我们切换到“我的” Tab 页。</p><ol><li>点击“帮助”。</li><li>这个页面没有返回按钮，但是有一个“回到首页”的功能，点击它，会调用 switchTab 返回首页。</li><li>注意页面栈的变化，“我的”这一条线被清空，替换回“首页”这一堆栈。</li></ol><p>页面栈好似一摞扑克牌，每张扑克代表一个页面，每次只能有一摞，最底下的一张是首页或 Tab 页，进入新页面（navigateTo）相当于在上面放一张新牌，后退（navigateBack）相当于剔除一张，直到只剩最后一张，切换 Tab 时推倒重来。</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/ability/custom-tabbar.html">自定义 TabBar（custom-tab-bar）</a>的行为是与原生 TabBar 保持一致的。</p></div></div><blockquote><p>题外话：如果你接触的小程序项目比较多，那你一定见过在有些项目里，TabBar 没有使用微信给出的方案，而是采用自定义组件实现 TabBar 的效果，并把几个 Tab 页合并成一个巨大的首页。纵使千百个理由，无非是一个借口，对小程序缺乏理解而去生搬硬套 Web 里的东西。</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="总结"></a>总结<a aria-hidden="true" tabindex="-1" class="hash-link" href="#总结" title="Direct link to heading">#</a></h2><p><strong>那么页面会在什么情况下卸载（<code>componentWillUnmount</code>），什么情况下隐藏（<code>onDidHide</code>）呢？</strong></p><p>卸载（<code>componentWillUnmount</code>）会在以下情况时发生：</p><ol><li>后退，包括点击后退按钮或调用 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.navigateBack.html"><code>navigateBack</code></a>。</li><li><a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.redirectTo.html"><code>redirectTo</code></a>，相当于在页面栈里替换掉当前页面。</li><li>非 Tab 页调用 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.switchTab.html"><code>switchTab</code></a>。</li><li><a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.reLaunch.html"><code>reLaunch</code></a>，当前所有页面都会卸载，包括 Tab 页。</li></ol><p>隐藏（<code>onDidHide</code>）会在以下情况时发生：</p><ol><li>以上 4 种情况因为页面卸载了，自然会触发隐藏。</li><li>前往新页面，<a href="https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.navigateTo.html"><code>navigateTo</code></a> 或 <a href="https://developers.weixin.qq.com/miniprogram/dev/component/navigator.html"><code>&lt;navigator&gt;</code></a> 组件。</li><li>弹出微信原生界面，例如：授权、拍照、分享、浮窗、设置等。</li><li>弹出手机原生界面，例如：来电、切换后台等。</li><li>微信 App 最小化。</li><li>可能还有更多。。。</li></ol></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/mini-program">MiniProgram</a><a class="margin-horiz--sm" href="/blog/tags/router">Router</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2020-06-25-what-is-react"><div class="pagination-nav__sublabel">Next Post</div><div class="pagination-nav__label">什么是 React？ »</div></a></div></nav></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文档</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/ui/README">重新发明的 UI</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/hooks/README">必备 Hooks</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/library/README">第三方 Library</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/polyfill/README">运行时补丁 Polyfill</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/history/README">History API</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">社区</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">博客</a></li><li class="footer__item"><a href="https://github.com/tarojsx" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">资源</h4><ul class="footer__items"><li class="footer__item"><a href="https://tarojsx.gitee.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">国内镜像站点 🇨🇳</a></li><li class="footer__item"><a href="https://tarojsx.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">海外站点 🌏</a></li></ul></div></div><div class="text--center"><div>Copyright © 2019-2020 TaroX org. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.d3ec5c41.js"></script>
<script src="/runtime~main.667b2516.js"></script>
<script src="/main.8e74c15f.js"></script>
<script src="/3.97b79253.js"></script>
<script src="/4.6e302ae9.js"></script>
<script src="/5.c384214e.js"></script>
<script src="/ccc49370.58823dac.js"></script>
<script src="/162.7313dacb.js"></script>
<script src="/1494de57.7598e39e.js"></script>
</body>
</html>